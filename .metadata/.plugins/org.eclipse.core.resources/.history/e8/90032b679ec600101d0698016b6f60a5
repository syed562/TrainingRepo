package com.flightapp.service;

import java.time.LocalDate;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.flightapp.FlightBookingSystemWebFluxApplication;
import com.flightapp.dto.FlighRequestSearch;
import com.flightapp.dto.FlightResponse;
import com.flightapp.dto.InventoryRequest;
import com.flightapp.models.Flight;
import com.flightapp.repo.AirlineRepo;
import com.flightapp.repo.BookingRepo;
import com.flightapp.repo.FlightRepo;
import com.flightapp.repo.PassengerRepo;

import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

@Service
public class FlighService {

    private final FlightBookingSystemWebFluxApplication flightBookingSystemWebFluxApplication;

	@Autowired
	FlightRepo fr;
	@Autowired
	AirlineRepo ar;
	@Autowired
	PassengerRepo pr;
	
	@Autowired
	BookingRepo br;

    FlighService(FlightBookingSystemWebFluxApplication flightBookingSystemWebFluxApplication) {
        this.flightBookingSystemWebFluxApplication = flightBookingSystemWebFluxApplication;
    }
	
	public Mono<FlightResponse>addFlightInventory(InventoryRequest req){
		return  ar.findById(req.getAirlineId()).switchIfEmpty(Mono.error(new RuntimeException("Airline not found"))).
				flatMap(airline->{
					Flight fli=new Flight();
					fli.setFlightNumber(req.getFlightNumber());
					fli.setAirline(airline);
					fli.setFromPlace(req.getFromPlace());
					fli.setToPlace(req.getToPlace());
					fli.setDepartureTime(req.getDepartureTime());
					fli.setArrivalTime(req.getArrivalTime());
					fli.setPrice(req.getPrice());
					fli.setTotalSeats(req.getTotalSeats());
					fli.setAvailableSeats(req.getTotalSeats());
					fli.setTripType(req.getTripType());
				
					 return fr.save(fli);	
				}).map(this::mapToFlightResponse);
		
	}
	
	
	private FlightResponse mapToFlightResponse(Flight flight) {
	    FlightResponse response = new FlightResponse();
	    response.setFlightId(flight.getFlightId());
	    response.setFlightNumber(flight.getFlightNumber());
	    response.setFromPlace(flight.getFromPlace());
	    response.setToPlace(flight.getToPlace());
	    response.setDepartTime(flight.getDepartureTime());
	    response.setArrivalTime(flight.getArrivalTime());
	    response.setPrice(flight.getPrice());
	    response.setTotalSeats(flight.getTotalSeats());
	    response.setAvailableSeats(flight.getAvailableSeats());
	    response.setTripType(flight.getTripType());
	    return response;
	}

	public Flux<FlightResponse> searchFlights(FlighRequestSearch searchRequest){
		
		LocalDate searchDate=searchRequest.getDepartDate();
		return fr.findByFromPlaceAndToPlaceAndDepartureDateAndAvailableSeatsGreaterThan(searchRequest.getFromPlace(),searchRequest.getToPlace(),searchDate).map(this::mapToFlightResponse);
		
	}
	
	
}
